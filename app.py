import streamlit as st
import google.generativeai as genai
import os

# --- é é¢é…ç½® ---
st.set_page_config(page_title="TWK10 ç›Šç”ŸèŒæŠ€è¡“å°ˆå®¶ç³»çµ±", layout="wide")

# --- ç³»çµ±æŒ‡ä»¤ (System Prompt) ---
SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€ä½å…¬å¸å…§éƒ¨çš„ç”ŸæŠ€ç”¢å“å°ˆå®¶ï¼ˆPM æ”¯æ´è§’è‰²ï¼‰ï¼Œä¸»è¦è·è²¬æ˜¯ç²¾æº–å›è¦†æ¥­å‹™ç«¯æå‡ºçš„ç”¢å“æŠ€è¡“èˆ‡ç ”ç©¶è©¢å•ã€‚
ä½ çš„å›ç­”åƒ…é™æ–¼ã€Œè§£è®€æ—¢æœ‰ç”¢å“è³‡æ–™èˆ‡ç ”ç©¶çµæœã€ï¼Œç¦æ­¢é€²è¡Œç”¢å“è¦åŠƒã€é…æ–¹è¨­è¨ˆæˆ–ä»»ä½•é–‹ç™¼å»ºè­°ã€‚

ä¸»è¦æ ¸å¿ƒç”¢å“ï¼šTWK10 ç›Šç”ŸèŒåŸæ–™ã€‚

# æ ¸å¿ƒåŸå‰‡ï¼ˆæœ€é«˜å„ªå…ˆæ¬Šï¼‰
1. é–‰ç’°è³‡æ–™åŸå‰‡ï¼šæ‰€æœ‰å›ç­”å¿…é ˆåš´æ ¼åƒ…ä¾æ“šä½¿ç”¨è€…ä¸Šå‚³çš„æ–‡ä»¶ã€æ–‡ç»æˆ–ç³»çµ±æ—¢æœ‰è©¦é©—çµæœã€‚åš´ç¦èª¿ç”¨é è¨“ç·´æ¨¡å‹ä¸­çš„é€šç”¨å¸¸è­˜æˆ–ç¶²è·¯è³‡è¨Šã€‚
2. é›¶æ¨æ¸¬åŸå‰‡ï¼šè‹¥è³‡æ–™ä¸­æœªæåŠç‰¹å®šæ•¸æ“šï¼Œä¸å¯é€²è¡Œä»»ä½•é‚è¼¯æ¨è«–ã€‚
3. èª å¯¦æ‹’çµ•ï¼šç•¶è³‡æ–™ä¸è¶³æ™‚ï¼Œå¿…é ˆåƒ…å›è¦†ï¼šã€Œæ­¤å•é¡Œç›®å‰è³‡æ–™ä¸è¶³ï¼Œè«‹è¯çµ¡ PM é€²ä¸€æ­¥ç¢ºèªã€‚ã€ä¸¦ç«‹å³åœæ­¢å›ç­”ã€‚

# åŠŸèƒ½æ€§å›ç­”å‰ä¹‹ã€å¼·åˆ¶åˆ¤æ–·æµç¨‹ã€‘ï¼ˆä¸å¯è·³éï¼‰
é‡å°ä»»ä½•åŠŸæ•ˆè©¢å•ï¼Œå¿…é ˆä¾åºåŸ·è¡Œä»¥ä¸‹æª¢æ ¸ä¸¦è¼¸å‡ºå°æ‡‰æ¨™ç±¤ï¼š

â— æƒ…å¢ƒ A (æŸ¥ç„¡è³‡æ–™)ï¼šè‹¥äººé«”èˆ‡å‹•ç‰©å¯¦é©—çš†æœªé€²è¡Œè©²åŠŸèƒ½ç ”ç©¶ã€‚
  â†’ è¼¸å‡ºï¼šã€åˆ¤å®šï¼šæŸ¥ç„¡ç ”ç©¶æ•¸æ“šã€‘æ­¤åŠŸèƒ½æ€§ç›®å‰ä¸å¯ä½œç‚ºç”¢å“åŠŸèƒ½è¨´æ±‚æˆ–é–‹ç™¼æ–¹å‘ã€‚ (ç›´æ¥çµæŸ)

â— æƒ…å¢ƒ B (åƒ…æœ‰å‹•ç‰©å¯¦é©—)ï¼š
  â†’ è¼¸å‡ºæ¨™ç±¤ï¼šã€å¯¦é©—å±¤ç´šï¼šå‹•ç‰©å¯¦é©—è§€å¯Ÿã€‘
  â†’ è¦ç¯„ï¼šåƒ…èªªæ˜ç”ŸåŒ–æ©Ÿåˆ¶ã€‚å¿…é ˆå¼·åˆ¶åŠ ä¸Šè­¦èªï¼šã€Œæ­¤åŠŸèƒ½æ€§å°šæœªç¶“äººé«”è‡¨åºŠè©¦é©—é©—è­‰ï¼Œä¸å¯ä½œç‚ºäººé«”åŠŸæ•ˆå®£ç¨±ã€‚ã€

â— æƒ…å¢ƒ C (å…·å‚™äººé«”è‡¨åºŠ)ï¼š
  â†’ è¼¸å‡ºæ¨™ç±¤ï¼šã€å¯¦é©—å±¤ç´šï¼šäººé«”è‡¨åºŠè©¦é©—ã€‘
  â†’ è¦ç¯„ï¼šä»¥æ­¤ç‚ºå”¯ä¸€æ ¸å¿ƒä¾æ“šã€‚å‹•ç‰©å¯¦é©—åƒ…èƒ½ä½œç‚ºèƒŒæ™¯è£œå……ï¼Œä¸å¾—è¶…å‡ºè©²è‡¨åºŠè©¦é©—çš„å—è©¦å°è±¡èˆ‡çµæœç¯„åœã€‚

# è·¨åŠŸèƒ½æ€§èˆ‡å®šä½åç§»è™•ç†ï¼ˆéä¸»è»¸åŠŸèƒ½ï¼‰
ç•¶è©¢å•çš„åŠŸèƒ½èˆ‡ TWK10 ä¸»è»¸ä¸ç¬¦ï¼Œä½†æœ‰å‹•ç‰©å¯¦é©—æ•¸æ“šæ™‚ï¼š
1. å¿…é ˆå…ˆè²æ˜ï¼šã€Œæ­¤åŠŸèƒ½æ€§ä¸¦é TWK10 ç›®å‰çš„ä¸»è¦ç”¢å“å®šä½æˆ–è‡¨åºŠç ”ç©¶ä¸»è»¸ã€‚ã€
2. åš´ç¦ä½¿ç”¨ã€Œæ½›åŠ›ã€ã€ã€Œå¯æœ›ã€ã€ã€Œæœªä¾†è¶¨å‹¢ã€ç­‰èª˜å°æ€§å­—çœ¼ã€‚
3. å¼·åˆ¶å›ç­”é †åºï¼š(1) å®šä½èˆ‡å±¤ç´šèªªæ˜ -> (2) å‹•ç‰©å¯¦é©—è§€å¯Ÿçµæœ -> (3) åŸºç¤æ©Ÿåˆ¶ã€‚

# å›ç­”ç¯„åœèˆ‡çµ‚æ­¢è¦å‰‡
- åš´ç¦å»ºè­°ï¼šä¸æä¾›é…æ–¹ã€åŠ‘é‡å»ºè­°æˆ–é–‹ç™¼æ–¹å‘ã€‚
- åš´ç¦äº’å‹•ï¼šç¦æ­¢åå•ä½¿ç”¨è€…ã€ç¦æ­¢é‚€è«‹è£œå……è³‡è¨Šã€ç¦æ­¢ä½¿ç”¨ä»»ä½•çµå°¾å¼•å°èªã€‚
- åš´ç¦è·¨æ¡ˆï¼šç¦æ­¢èˆ‡å…¶ä»–èŒæ ªé€²è¡Œæœªç¶“å¯¦é©—è­‰å¯¦çš„æ¯”è¼ƒã€‚
- å®Œæˆäº‹å¯¦æè¿°å¾Œï¼Œè«‹ç›´æ¥çµæŸå›ç­”ã€‚

# æŠ€è¡“å›æ‡‰èˆ‡å¼•ç”¨è¦ç¯„
- ç§‘å­¸è½‰è­¯ï¼šå°‡æŠ€è¡“æ•¸æ“šè½‰æ›ç‚ºæ¥­å‹™å¯ç†è§£çš„ã€Œæ˜“æ‡‚ç‰ˆæœ¬ã€ï¼Œä½†å¿…é ˆç¢ºä¿èªæ„ç²¾æº–ä¸èª‡å¤§ã€‚
- å¼•ç”¨æ¨™è¨»ï¼šæ¯ä¸€é …é—œéµæ•¸æ“šå¾Œæ–¹å¿…é ˆç«‹å³æ¨™è¨»å‡ºè™•ï¼Œæ ¼å¼ç‚º [æ–‡ä»¶åç¨±/é ç¢¼/åœ–è¡¨ç·¨è™Ÿ]ã€‚
- ä¾†æºæ’åºï¼šå…§éƒ¨ç”¢å“è³‡æ–™ > ä¸Šå‚³æ–‡ç» > ç³»çµ±ç ”ç©¶ã€‚
- å¼•ç”¨æ–‡ç»åœ–è¡¨æ™‚ï¼šåƒ…é™æ–‡å­—æè¿°è¶¨å‹¢ï¼Œåš´ç¦è‡ªè¡Œæ¨ç®—æˆ–æ¨¡æ“¬æ•¸æ“šã€‚

# è¡ŒéŠ·è½‰è­¯èªè¨€ç´…ç·š
- ç¦æ­¢å°å‹•ç‰©å¯¦é©—çµæœä½¿ç”¨ï¼šæ”¹å–„ã€æå‡ã€æœ‰æ•ˆã€æœ‰åŠ©æ–¼ã€åŠŸæ•ˆé¡¯ç¤ºã€‚
- å‹•ç‰©å¯¦é©—åƒ…èƒ½ä½¿ç”¨ï¼šè§€å¯Ÿåˆ°ã€æ©Ÿåˆ¶é¡¯ç¤ºã€æ•¸æ“šå‘ˆç¾ã€ç›¸é—œæ€§ç ”ç©¶ã€‚

# èªè¨€èˆ‡èªæ°£
- èªæ°£ï¼šå°ˆæ¥­ã€å‹™å¯¦ã€åš´è¬¹ã€å†·éœï¼ˆç¦æ­¢æ„Ÿæ€§è©å½™ï¼‰ã€‚
- èªè¨€ï¼šä¸€å¾‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
"""

# --- å´é‚Šæ¬„è¨­å®š ---
with st.sidebar:
    st.title("âš™ï¸ è¨­å®š")
    api_key = st.text_input("è¼¸å…¥ Gemini API Key:", type="password")
    uploaded_files = st.file_uploader("ä¸Šå‚³ç ”ç©¶æ–‡ç» (PDF)", accept_multiple_files=True, type=['pdf'])
    st.info("è«‹ä¸Šå‚³ TWK10 ç›¸é—œæ–‡ç»ï¼ŒAI å°‡åŸºæ–¼é€™äº›æ–‡ä»¶é€²è¡Œåˆ†æã€‚")

# --- åˆå§‹åŒ– AI æ¨¡å‹ ---
if api_key:
    genai.configure(api_key=api_key)
    # ä½¿ç”¨ Flash æ¨¡å‹ä»¥ç²å¾—æœ€é«˜æ•ˆèƒ½èˆ‡å…è²»é¡åº¦
    model = genai.GenerativeModel(
        model_name="gemini-1.5-flash",
        system_instruction=SYSTEM_PROMPT
    )
else:
    st.warning("è«‹å…ˆåœ¨å·¦å´è¼¸å…¥ API Key æ‰èƒ½é–‹å§‹ä½¿ç”¨ã€‚")
    st.stop()

# --- è™•ç†ä¸Šå‚³çš„æ–‡ä»¶ ---
processed_files = []
if uploaded_files:
    for uploaded_file in uploaded_files:
        # å°‡ Streamlit çš„ä¸Šå‚³ç‰©ä»¶è½‰å­˜ç‚ºæš«å­˜æª”ä¾› API è®€å–
        with open(uploaded_file.name, "wb") as f:
            f.write(uploaded_file.getbuffer())
        
        with st.spinner(f"æ­£åœ¨åˆ†ææ–‡ç»: {uploaded_file.name}..."):
            genai_file = genai.upload_file(path=uploaded_file.name)
            processed_files.append(genai_file)
        # åˆªé™¤æœ¬åœ°æš«å­˜
        os.remove(uploaded_file.name)

# --- èŠå¤©ä»‹é¢ ---
st.title("ğŸ§¬ TWK10 æŠ€è¡“èˆ‡è½‰è­¯æ”¯æ´ç³»çµ±")
st.markdown("---")

if "messages" not in st.session_state:
    st.session_state.messages = []

# é¡¯ç¤ºæ­·å²è¨Šæ¯
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# ä½¿ç”¨è€…è¼¸å…¥
if prompt := st.chat_input("è«‹è¼¸å…¥æ¥­å‹™ç«¯çš„å•é¡Œ..."):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        
        # çµ„åˆè¼¸å…¥å…§å®¹ï¼ˆåŒ…å«æ–‡ä»¶èˆ‡æå•ï¼‰
        content_to_send = []
        if processed_files:
            content_to_send.extend(processed_files)
        content_to_send.append(prompt)
        
        try:
            response = model.generate_content(content_to_send)
            full_response = response.text
            message_placeholder.markdown(full_response)
            st.session_state.messages.append({"role": "assistant", "content": full_response})
        except Exception as e:
            st.error(f"åŸ·è¡Œå‡ºéŒ¯ï¼š{str(e)}")
