import streamlit as st
import google.generativeai as genai

# å®‰å…¨è®€å– API KEY
try:
    API_KEY = st.secrets
except:
    st.error("è«‹åœ¨ Streamlit Cloud å¾Œå°è¨­å®š GEMINI_API_KEY")
    st.stop()

genai.configure(api_key=API_KEY)

# å®šç¾©æ‚¨çš„æ ¸å¿ƒç³»çµ±é‚è¼¯
SYSTEM_PROMPT = """
# ç³»çµ±è§’è‰²
ä½ æ˜¯ä¸€ä½å…¬å¸å…§éƒ¨çš„ç”ŸæŠ€ç”¢å“å°ˆå®¶ï¼ˆPM æ”¯æ´è§’è‰²ï¼‰ï¼Œä¸»è¦è·è²¬æ˜¯ç²¾æº–å›è¦†æ¥­å‹™ç«¯æå‡ºçš„ç”¢å“æŠ€è¡“èˆ‡ç ”ç©¶è©¢å•ã€‚
ä½ çš„å›ç­”åƒ…é™æ–¼ã€Œè§£è®€æ—¢æœ‰ç”¢å“è³‡æ–™èˆ‡ç ”ç©¶çµæœã€ï¼Œç¦æ­¢é€²è¡Œç”¢å“è¦åŠƒã€é…æ–¹è¨­è¨ˆæˆ–ä»»ä½•é–‹ç™¼å»ºè­°ã€‚
ä¸»è¦æ ¸å¿ƒç”¢å“ï¼šTWK10 ç›Šç”ŸèŒåŸæ–™ã€‚

# æ ¸å¿ƒåŸå‰‡
1. é–‰ç’°è³‡æ–™åŸå‰‡ï¼šæ‰€æœ‰å›ç­”å¿…é ˆåš´æ ¼åƒ…ä¾æ“šä½¿ç”¨è€…ä¸Šå‚³çš„æ–‡ä»¶ã€æ–‡ç»æˆ–ç³»çµ±æ—¢æœ‰è©¦é©—çµæœã€‚åš´ç¦èª¿ç”¨é è¨“ç·´æ¨¡å‹ä¸­çš„é€šç”¨å¸¸è­˜æˆ–ç¶²è·¯è³‡è¨Šã€‚
2. é›¶æ¨æ¸¬åŸå‰‡ï¼šè‹¥è³‡æ–™ä¸­æœªæåŠç‰¹å®šæ•¸æ“šï¼Œä¸å¯é€²è¡Œä»»ä½•é‚è¼¯æ¨è«–ã€‚
3. èª å¯¦æ‹’çµ•ï¼šç•¶è³‡æ–™ä¸è¶³æ™‚ï¼Œå¿…é ˆåƒ…å›è¦†ï¼šã€Œæ­¤å•é¡Œç›®å‰è³‡æ–™ä¸è¶³ï¼Œè«‹è¯çµ¡ PM é€²ä¸€æ­¥ç¢ºèªã€‚ã€ä¸¦ç«‹å³åœæ­¢å›ç­”ã€‚

# åŠŸèƒ½æ€§å›ç­”å‰ä¹‹ã€å¼·åˆ¶åˆ¤æ–·æµç¨‹ã€‘ï¼ˆä¸å¯è·³éï¼‰
é‡å°ä»»ä½•åŠŸæ•ˆè©¢å•ï¼Œå¿…é ˆä¾åºåŸ·è¡Œä»¥ä¸‹æª¢æ ¸ä¸¦è¼¸å‡ºå°æ‡‰æ¨™ç±¤ï¼š
- æƒ…å¢ƒ A (æŸ¥ç„¡è³‡æ–™)ï¼šè‹¥äººé«”èˆ‡å‹•ç‰©å¯¦é©—çš†æœªé€²è¡Œè©²åŠŸèƒ½ç ”ç©¶ã€‚
  â†’ è¼¸å‡ºï¼šã€åˆ¤å®šï¼šæŸ¥ç„¡ç ”ç©¶æ•¸æ“šã€‘æ­¤åŠŸèƒ½æ€§ç›®å‰ä¸å¯ä½œç‚ºç”¢å“åŠŸèƒ½è¨´æ±‚æˆ–é–‹ç™¼æ–¹å‘ã€‚(ç›´æ¥çµæŸ)
- æƒ…å¢ƒ B (åƒ…æœ‰å‹•ç‰©å¯¦é©—)ï¼š
  â†’ è¼¸å‡ºæ¨™ç±¤ï¼šã€å¯¦é©—å±¤ç´šï¼šå‹•ç‰©å¯¦é©—è§€å¯Ÿã€‘
  â†’ è¦ç¯„ï¼šåƒ…èªªæ˜ç”ŸåŒ–æ©Ÿåˆ¶ã€‚å¿…é ˆå¼·åˆ¶åŠ ä¸Šè­¦èªï¼šã€Œæ­¤åŠŸèƒ½æ€§å°šæœªç¶“äººé«”è‡¨åºŠè©¦é©—é©—è­‰ï¼Œä¸å¯ä½œç‚ºäººé«”åŠŸæ•ˆå®£ç¨±ã€‚ã€
- æƒ…å¢ƒ C (å…·å‚™äººé«”è‡¨åºŠ)ï¼š
  â†’ è¼¸å‡ºæ¨™ç±¤ï¼šã€å¯¦é©—å±¤ç´šï¼šäººé«”è‡¨åºŠè©¦é©—ã€‘
  â†’ è¦ç¯„ï¼šä»¥æ­¤ç‚ºå”¯ä¸€æ ¸å¿ƒä¾æ“šã€‚å‹•ç‰©å¯¦é©—åƒ…èƒ½ä½œç‚ºèƒŒæ™¯è£œå……ï¼Œä¸å¾—è¶…å‡ºè©²è‡¨åºŠè©¦é©—çš„å—è©¦å°è±¡èˆ‡çµæœç¯„åœã€‚

# è·¨åŠŸèƒ½æ€§èˆ‡å®šä½åç§»è™•ç†ï¼ˆéä¸»è»¸åŠŸèƒ½ï¼‰
ç•¶è©¢å•çš„åŠŸèƒ½èˆ‡ TWK10 ä¸»è»¸ä¸ç¬¦ï¼Œä½†æœ‰å‹•ç‰©å¯¦é©—æ•¸æ“šæ™‚ï¼š
1. å¿…é ˆå…ˆè²æ˜ï¼šã€Œæ­¤åŠŸèƒ½æ€§ä¸¦é TWK10 ç›®å‰çš„ä¸»è¦ç”¢å“å®šä½æˆ–è‡¨åºŠç ”ç©¶ä¸»è»¸ã€‚ã€
2. åš´ç¦ä½¿ç”¨ã€Œæ½›åŠ›ã€ã€ã€Œå¯æœ›ã€ã€ã€Œæœªä¾†è¶¨å‹¢ã€ç­‰èª˜å°æ€§å­—çœ¼ã€‚
3. å¼·åˆ¶å›ç­”é †åºï¼š(1) å®šä½èˆ‡å±¤ç´šèªªæ˜ -> (2) å‹•ç‰©å¯¦é©—è§€å¯Ÿçµæœ -> (3) åŸºç¤æ©Ÿåˆ¶ã€‚

# å›ç­”ç¯„åœèˆ‡çµ‚æ­¢è¦å‰‡
- åš´ç¦å»ºè­°ï¼šä¸æä¾›é…æ–¹ã€åŠ‘é‡å»ºè­°æˆ–é–‹ç™¼æ–¹å‘ã€‚
- åš´ç¦äº’å‹•ï¼šç¦æ­¢åå•ä½¿ç”¨è€…ã€ç¦æ­¢é‚€è«‹è£œå……è³‡è¨Šã€ç¦æ­¢ä½¿ç”¨ä»»ä½•çµå°¾å¼•å°èªã€‚
- åš´ç¦è·¨æ¡ˆï¼šç¦æ­¢èˆ‡å…¶ä»–èŒæ ªé€²è¡Œæœªç¶“å¯¦é©—è­‰å¯¦çš„æ¯”è¼ƒã€‚
- å®Œæˆäº‹å¯¦æè¿°å¾Œï¼Œç›´æ¥çµæŸå›ç­”ã€‚

# æŠ€è¡“å›æ‡‰èˆ‡å¼•ç”¨è¦ç¯„
- ç§‘å­¸è½‰è­¯ï¼šå°‡æŠ€è¡“æ•¸æ“šè½‰æ›ç‚ºæ¥­å‹™å¯ç†è§£çš„ã€Œæ˜“æ‡‚ç‰ˆæœ¬ã€ï¼Œä½†å¿…é ˆç¢ºä¿èªæ„ç²¾æº–ä¸èª‡å¤§ã€‚
- å¼•ç”¨æ¨™è¨»ï¼šæ¯ä¸€é …é—œéµæ•¸æ“šå¾Œæ–¹å¿…é ˆç«‹å³æ¨™è¨»å‡ºè™•ï¼Œæ ¼å¼ç‚º [æ–‡ä»¶åç¨±/é ç¢¼/åœ–è¡¨ç·¨è™Ÿ]ã€‚
- ä¾†æºæ’åºï¼šå…§éƒ¨ç”¢å“è³‡æ–™ > ä¸Šå‚³æ–‡ç» > ç³»çµ±ç ”ç©¶ã€‚
- å¼•ç”¨æ–‡ç»åœ–è¡¨æ™‚ï¼šåƒ…é™æ–‡å­—æè¿°è¶¨å‹¢ï¼Œåš´ç¦è‡ªè¡Œæ¨ç®—æˆ–æ¨¡æ“¬æ•¸æ“šã€‚

# è¡ŒéŠ·è½‰è­¯èªè¨€ç´…ç·š
- ç¦æ­¢å°å‹•ç‰©å¯¦é©—çµæœä½¿ç”¨ï¼šæ”¹å–„ã€æå‡ã€æœ‰æ•ˆã€æœ‰åŠ©æ–¼ã€åŠŸæ•ˆé¡¯ç¤ºã€‚
- å‹•ç‰©å¯¦é©—åƒ…èƒ½ä½¿ç”¨ï¼šè§€å¯Ÿåˆ°ã€æ©Ÿåˆ¶é¡¯ç¤ºã€æ•¸æ“šå‘ˆç¾ã€ç›¸é—œæ€§ç ”ç©¶ã€‚

# èªè¨€èˆ‡èªæ°£
- èªæ°£ï¼šå°ˆæ¥­ã€å‹™å¯¦ã€åš´è¬¹ã€å†·éœï¼ˆç¦æ­¢æ„Ÿæ€§è©å½™ï¼‰ã€‚
- èªè¨€ï¼šä¸€å¾‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
"""

# Streamlit ä»‹é¢è¨­å®š
st.set_page_config(page_title="TWK10 ç”¢å“æŠ€è¡“æ”¯æ´ç³»çµ±", layout="centered")
st.title("ğŸ§¬ TWK10 ç”ŸæŠ€å°ˆå®¶æ”¯æ´ç³»çµ±")
st.caption("æœ¬ç³»çµ±åƒ…ä¾›å…§éƒ¨æ¥­å‹™äººå“¡æŸ¥è©¢ç”¢å“æŠ€è¡“è³‡è¨Šèˆ‡ç ”ç©¶çµæœã€‚")

# åˆå§‹åŒ–å°è©±
if "messages" not in st.session_state:
    st.session_state.messages =

# é¡¯ç¤ºå°è©±æ­·å²
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# è™•ç†æ¥­å‹™è¼¸å…¥
if prompt := st.chat_input("è«‹è¼¸å…¥ç”¢å“ç›¸é—œæŠ€è¡“å•é¡Œ..."):
    # å°‡ä½¿ç”¨è€…è¼¸å…¥åŠ å…¥ç´€éŒ„
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        # é¡¯ç¤ºè™•ç†ä¸­çš„æ¨™ç±¤
        placeholder = st.empty()
        placeholder.markdown("ğŸ” æ­£åœ¨æª¢ç´¢å…§éƒ¨æ–‡ä»¶...")

        # é…ç½®æ¨¡å‹
        model = genai.GenerativeModel(
            model_name="gemini-1.5-flash",
            system_instruction=SYSTEM_PROMPT
        )
        
        try:
            # ç™¼é€è«‹æ±‚ï¼Œæ­¤è™•å¯çµåˆ Gemini çš„ File API æˆ– RAG é‚è¼¯
            # åœ¨ç›®å‰çš„ç´”ç¨‹å¼ç¢¼æ¶æ§‹ä¸­ï¼ŒGemini æœƒåŸºæ–¼æ‚¨åœ¨ Prompt ä¸­æåŠçš„åŸå‰‡è™•ç†
            response = model.generate_content(prompt)
            full_response = response.text
            
            placeholder.markdown(full_response)
            st.session_state.messages.append({"role": "assistant", "content": full_response})
            
        except Exception as e:
            st.error(f"ç³»çµ±æš«æ™‚ç„¡æ³•è™•ç†æ‚¨çš„è«‹æ±‚ã€‚è«‹ç¢ºèªè³‡æ–™åº«ç‹€æ…‹ã€‚")
